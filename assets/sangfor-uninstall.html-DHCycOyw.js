import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,a as l,o as p}from"./app-qg5HrpHV.js";const o={};function e(t,s){return p(),a("div",null,s[0]||(s[0]=[l(`<p>大概一年多前对象需要用我的电脑完成工作相关的一些事情，需要安装深信服的一些软件来远程操控公司电脑。事后我卸载了相关软件，运行的是软件自带的uninstall程序。</p><p>但是最近查看任务管理器的进程列表，竟然还是看到了Sangfor开头的进程，甚是无语。</p><h2 id="删除服务" tabindex="-1"><a class="header-anchor" href="#删除服务"><span>删除服务</span></a></h2><p>想到每次开机都会自启动，第一想法就是系统服务项中会不会有，打开Windows的服务管理(services.msc)，按名称排列寻找S开头的服务，好家伙，第一个就是<code>Sangfor VPN Security Protect Service</code>，关闭此服务后我尝试设置禁用，竟然还拒绝访问！随即尝试以下步骤：</p><h3 id="管理员运行services-msc" tabindex="-1"><a class="header-anchor" href="#管理员运行services-msc"><span>管理员运行services.msc</span></a></h3><p>Win + R输入services.msc，Ctrl + Shift + Enter管理员运行，无效，仍然拒绝访问。</p><h3 id="改注册表" tabindex="-1"><a class="header-anchor" href="#改注册表"><span>改注册表</span></a></h3><p>从服务列表中可以看到这个服务真实名称是<code>SangforPWEx</code></p><p>找到注册表路径<code>HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\SangforPWEx</code>，修改其start值为4（即DISABLED），修改失败，管理员模式下也无效。</p><h3 id="sc-delete命令" tabindex="-1"><a class="header-anchor" href="#sc-delete命令"><span>sc delete命令</span></a></h3><p>直接管理员cmd运行<code>sc delete SangforPWEx</code>，删除成功</p><h2 id="删除驱动" tabindex="-1"><a class="header-anchor" href="#删除驱动"><span>删除驱动</span></a></h2><p>cmd运行<code>driverquery | findstr /i sangfor</code>，找到以下输出，说明还有残留驱动：</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" data-title="bash" style="background-color:#1E1E1E;color:#D4D4D4;"><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#DCDCAA;">SangforVnic</span><span style="color:#CE9178;">  Sangfor</span><span style="color:#CE9178;"> SSL</span><span style="color:#CE9178;"> VPN</span><span style="color:#CE9178;"> CS</span><span style="color:#CE9178;"> Sup</span><span style="color:#CE9178;"> Kernel</span><span style="color:#CE9178;">        2012/11/20</span><span style="color:#CE9178;"> 20:31:43</span></span></code></pre></div><h3 id="sc-delete命令-1" tabindex="-1"><a class="header-anchor" href="#sc-delete命令-1"><span>sc delete命令</span></a></h3><p>如法炮制，sc delete一条命令直接删除了</p><h2 id="其他残留" tabindex="-1"><a class="header-anchor" href="#其他残留"><span>其他残留</span></a></h2><h3 id="注册表" tabindex="-1"><a class="header-anchor" href="#注册表"><span>注册表</span></a></h3><p>注册表全局搜索sangfor，找到<code>计算机\\HKEY_CLASSES_ROOT\\AppID\\某个APPID</code>下的LocalService的值为前面删除的<code>SangforPWEx</code></p><p>通过询问gpt得知，这仅是一个绑定关系，表示某个COM组件启动时需要用到<code>SangforPWEx</code>服务，通过<code>sc query SangforPWEx</code>寻找相关的依赖，得到以下输出：</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" data-title="bash" style="background-color:#1E1E1E;color:#D4D4D4;"><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#D4D4D4;">[SC] EnumQueryServicesStatus:OpenService 失败 1060:</span></span></code></pre></div><p>眼睛里容不得沙子，直接删除注册表该APPID整个目录。</p><p>上面因为已经删掉了相关服务，这些注册项已经属于无用注册项了，可以找一些注册表清理软件删除这些无用注册项，或者使用以下脚本专门删除Sangfor相关注册项（保存为xxx.ps1然后用pwsh运行）。</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" data-title="bash" style="background-color:#1E1E1E;color:#D4D4D4;"><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#D4D4D4;">&lt;#</span></span>
<span class="line"><span style="color:#DCDCAA;">.SYNOPSIS</span></span>
<span class="line"><span style="color:#DCDCAA;">  Find</span><span style="color:#D4D4D4;"> &amp; </span><span style="color:#DCDCAA;">remove</span><span style="color:#CE9178;"> Sangfor</span><span style="color:#CE9178;"> leftovers</span><span style="color:#D4D4D4;"> (COM/AppID/TypeLib/etc.) with backup.</span></span>
<span class="line"><span style="color:#DCDCAA;">  Default:</span><span style="color:#CE9178;"> dry-run.</span><span style="color:#CE9178;"> Use</span><span style="color:#569CD6;"> -Force</span><span style="color:#CE9178;"> to</span><span style="color:#CE9178;"> actually</span><span style="color:#CE9178;"> delete.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DCDCAA;">.USAGE</span></span>
<span class="line"><span style="color:#6A9955;">  # Dry-run (recommended first):</span></span>
<span class="line"><span style="color:#DCDCAA;">  powershell</span><span style="color:#569CD6;"> -ExecutionPolicy</span><span style="color:#CE9178;"> Bypass</span><span style="color:#569CD6;"> -File</span><span style="color:#CE9178;"> .</span><span style="color:#D7BA7D;">\\R</span><span style="color:#CE9178;">emove-Sangfor-Leftovers.ps1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  # Do it for real:</span></span>
<span class="line"><span style="color:#DCDCAA;">  powershell</span><span style="color:#569CD6;"> -ExecutionPolicy</span><span style="color:#CE9178;"> Bypass</span><span style="color:#569CD6;"> -File</span><span style="color:#CE9178;"> .</span><span style="color:#D7BA7D;">\\R</span><span style="color:#CE9178;">emove-Sangfor-Leftovers.ps1</span><span style="color:#569CD6;"> -Force</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  # Change backup folder:</span></span>
<span class="line"><span style="color:#DCDCAA;">  powershell</span><span style="color:#569CD6;"> -ExecutionPolicy</span><span style="color:#CE9178;"> Bypass</span><span style="color:#569CD6;"> -File</span><span style="color:#CE9178;"> .</span><span style="color:#D7BA7D;">\\R</span><span style="color:#CE9178;">emove-Sangfor-Leftovers.ps1</span><span style="color:#569CD6;"> -Force</span><span style="color:#569CD6;"> -BackupDir</span><span style="color:#CE9178;"> &quot;D:\\reg_backup&quot;</span></span>
<span class="line"><span style="color:#6A9955;">#&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DCDCAA;">param(</span></span>
<span class="line"><span style="color:#D4D4D4;">  [switch]</span><span style="color:#9CDCFE;">$Force</span><span style="color:#CE9178;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">  [string]</span><span style="color:#9CDCFE;">$BackupDir</span><span style="color:#CE9178;"> =</span><span style="color:#CE9178;"> &quot;</span><span style="color:#9CDCFE;">$env</span><span style="color:#CE9178;">:SystemDrive\\Sangfor_Removal_Backup&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DCDCAA;">Set-StrictMode</span><span style="color:#569CD6;"> -Version</span><span style="color:#CE9178;"> Latest</span></span>
<span class="line"><span style="color:#9CDCFE;">$ErrorActionPreference</span><span style="color:#D4D4D4;"> = </span><span style="color:#CE9178;">&quot;Stop&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">function</span><span style="color:#DCDCAA;"> Test-Admin</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#9CDCFE;">  $id</span><span style="color:#CE9178;"> =</span><span style="color:#D4D4D4;"> [Security.Principal.WindowsIdentity</span><span style="color:#DCDCAA;">]::GetCurrent</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#9CDCFE;">  $p</span><span style="color:#CE9178;">  =</span><span style="color:#CE9178;"> New-Object</span><span style="color:#CE9178;"> Security.Principal.WindowsPrincipal</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">$id</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#C586C0;">  return</span><span style="color:#9CDCFE;"> $p</span><span style="color:#CE9178;">.IsInRole</span><span style="color:#D4D4D4;">([Security.Principal.WindowsBuiltInRole]::Administrator)</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">function</span><span style="color:#DCDCAA;"> Ensure-Dir</span><span style="color:#D4D4D4;">([string]</span><span style="color:#9CDCFE;">$Path</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#C586C0;">  if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">-not</span><span style="color:#D4D4D4;"> (Test-Path </span><span style="color:#569CD6;">-LiteralPath</span><span style="color:#9CDCFE;"> $Path</span><span style="color:#D4D4D4;">)) {</span></span>
<span class="line"><span style="color:#DCDCAA;">    New-Item</span><span style="color:#569CD6;"> -ItemType</span><span style="color:#CE9178;"> Directory</span><span style="color:#569CD6;"> -Path</span><span style="color:#9CDCFE;"> $Path</span><span style="color:#D4D4D4;"> | </span><span style="color:#DCDCAA;">Out-Null</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">function</span><span style="color:#DCDCAA;"> Write-Plan</span><span style="color:#D4D4D4;">([string]</span><span style="color:#9CDCFE;">$msg</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#C586C0;">  if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">$Force</span><span style="color:#D4D4D4;">) { </span><span style="color:#DCDCAA;">Write-Host</span><span style="color:#CE9178;"> &quot;[DO]  </span><span style="color:#9CDCFE;">$msg</span><span style="color:#CE9178;">&quot;</span><span style="color:#569CD6;"> -ForegroundColor</span><span style="color:#CE9178;"> Yellow</span><span style="color:#CE9178;"> }</span></span>
<span class="line"><span style="color:#C586C0;">  else</span><span style="color:#D4D4D4;">        { </span><span style="color:#DCDCAA;">Write-Host</span><span style="color:#CE9178;"> &quot;[PLAN] </span><span style="color:#9CDCFE;">$msg</span><span style="color:#CE9178;">&quot;</span><span style="color:#569CD6;"> -ForegroundColor</span><span style="color:#CE9178;"> Cyan</span><span style="color:#CE9178;"> }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">function</span><span style="color:#DCDCAA;"> Write-Ok</span><span style="color:#D4D4D4;">([string]</span><span style="color:#9CDCFE;">$msg</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#DCDCAA;">  Write-Host</span><span style="color:#CE9178;"> &quot;[OK]  </span><span style="color:#9CDCFE;">$msg</span><span style="color:#CE9178;">&quot;</span><span style="color:#569CD6;"> -ForegroundColor</span><span style="color:#CE9178;"> Green</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">function</span><span style="color:#DCDCAA;"> Write-Warn</span><span style="color:#D4D4D4;">([string]</span><span style="color:#9CDCFE;">$msg</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#DCDCAA;">  Write-Host</span><span style="color:#CE9178;"> &quot;[WARN] </span><span style="color:#9CDCFE;">$msg</span><span style="color:#CE9178;">&quot;</span><span style="color:#569CD6;"> -ForegroundColor</span><span style="color:#CE9178;"> DarkYellow</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">function</span><span style="color:#DCDCAA;"> Backup-RegKey</span><span style="color:#D4D4D4;">([string]</span><span style="color:#9CDCFE;">$RegPath</span><span style="color:#D4D4D4;">, [string]</span><span style="color:#9CDCFE;">$NameHint</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#DCDCAA;">  Ensure-Dir</span><span style="color:#9CDCFE;"> $BackupDir</span></span>
<span class="line"><span style="color:#9CDCFE;">  $ts</span><span style="color:#CE9178;"> =</span><span style="color:#D4D4D4;"> (Get-Date).ToString(</span><span style="color:#DCDCAA;">&quot;yyyyMMdd_HHmmss&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#9CDCFE;">  $safe</span><span style="color:#CE9178;"> =</span><span style="color:#D4D4D4;"> ($NameHint </span><span style="color:#569CD6;">-replace</span><span style="color:#CE9178;"> &#39;[^a-zA-Z0-9_\\-\\.]&#39;,</span><span style="color:#CE9178;"> &#39;_&#39;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#9CDCFE;">  $out</span><span style="color:#CE9178;"> =</span><span style="color:#CE9178;"> Join-Path</span><span style="color:#9CDCFE;"> $BackupDir</span><span style="color:#CE9178;"> &quot;</span><span style="color:#9CDCFE;">$ts</span><span style="color:#CE9178;">\`</span><span style="color:#DCDCAA;">_$safe.reg&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DCDCAA;">  # reg.exe expects root like HKLM\\...</span></span>
<span class="line"><span style="color:#9CDCFE;">  $cmd</span><span style="color:#DCDCAA;"> = &quot;reg.exe</span><span style="color:#CE9178;"> export \`&quot;</span><span style="color:#9CDCFE;">$RegPath</span><span style="color:#CE9178;">\`</span><span style="color:#DCDCAA;">&quot; </span><span style="color:#CE9178;">\`</span><span style="color:#DCDCAA;">&quot;</span><span style="color:#9CDCFE;">$out</span><span style="color:#CE9178;">\`</span><span style="color:#DCDCAA;">&quot; /y&quot;</span></span>
<span class="line"><span style="color:#DCDCAA;">  Write-Plan</span><span style="color:#CE9178;"> &quot;Backup registry key: </span><span style="color:#9CDCFE;">$RegPath</span><span style="color:#CE9178;"> -&gt; </span><span style="color:#9CDCFE;">$out</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#C586C0;">  if</span><span style="color:#CE9178;"> (</span><span style="color:#9CDCFE;">$Force</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#DCDCAA;">    cmd.exe</span><span style="color:#CE9178;"> /c </span><span style="color:#9CDCFE;">$cmd</span><span style="color:#D4D4D4;"> |</span><span style="color:#DCDCAA;"> Out-Null</span></span>
<span class="line"><span style="color:#DCDCAA;">    Write-Ok</span><span style="color:#CE9178;"> &quot;Backed up: </span><span style="color:#9CDCFE;">$out</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#CE9178;">  }</span></span>
<span class="line"><span style="color:#CE9178;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">function</span><span style="color:#DCDCAA;"> Remove-RegKey</span><span style="color:#CE9178;">([string]</span><span style="color:#9CDCFE;">$PsPath</span><span style="color:#CE9178;">, [string]</span><span style="color:#9CDCFE;">$RegExportPath</span><span style="color:#CE9178;">, [string]</span><span style="color:#9CDCFE;">$NameHint</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#C586C0;">  if</span><span style="color:#CE9178;"> (</span><span style="color:#DCDCAA;">-not</span><span style="color:#CE9178;"> (Test-Path </span><span style="color:#569CD6;">-LiteralPath</span><span style="color:#9CDCFE;"> $PsPath</span><span style="color:#CE9178;">)) {</span></span>
<span class="line"><span style="color:#DCDCAA;">    Write-Warn</span><span style="color:#CE9178;"> &quot;Not found: </span><span style="color:#9CDCFE;">$PsPath</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#C586C0;">    return</span></span>
<span class="line"><span style="color:#CE9178;">  }</span></span>
<span class="line"><span style="color:#DCDCAA;">  Backup-RegKey</span><span style="color:#569CD6;"> -RegPath</span><span style="color:#9CDCFE;"> $RegExportPath</span><span style="color:#569CD6;"> -NameHint</span><span style="color:#9CDCFE;"> $NameHint</span></span>
<span class="line"><span style="color:#DCDCAA;">  Write-Plan</span><span style="color:#CE9178;"> &quot;Remove registry key: </span><span style="color:#9CDCFE;">$PsPath</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#C586C0;">  if</span><span style="color:#CE9178;"> (</span><span style="color:#9CDCFE;">$Force</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#DCDCAA;">    Remove-Item</span><span style="color:#569CD6;"> -LiteralPath</span><span style="color:#9CDCFE;"> $PsPath</span><span style="color:#569CD6;"> -Recurse</span><span style="color:#569CD6;"> -Force</span></span>
<span class="line"><span style="color:#DCDCAA;">    Write-Ok</span><span style="color:#CE9178;"> &quot;Removed: </span><span style="color:#9CDCFE;">$PsPath</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#CE9178;">  }</span></span>
<span class="line"><span style="color:#CE9178;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">function</span><span style="color:#DCDCAA;"> Remove-ServiceIfExists</span><span style="color:#CE9178;">([string]</span><span style="color:#9CDCFE;">$ServiceName</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#6A9955;">  # sc query returns 1060 if not installed</span></span>
<span class="line"><span style="color:#9CDCFE;">  $out</span><span style="color:#CE9178;"> = &amp; </span><span style="color:#DCDCAA;">sc.exe</span><span style="color:#CE9178;"> query </span><span style="color:#9CDCFE;">$ServiceName</span><span style="color:#D4D4D4;"> 2&gt;&amp;1</span><span style="color:#D4D4D4;"> |</span><span style="color:#DCDCAA;"> Out-String</span></span>
<span class="line"><span style="color:#C586C0;">  if</span><span style="color:#CE9178;"> (</span><span style="color:#9CDCFE;">$out</span><span style="color:#CE9178;"> -match &quot;1060&quot; -or </span><span style="color:#9CDCFE;">$out</span><span style="color:#CE9178;"> -match &quot;does not exist&quot; -or </span><span style="color:#9CDCFE;">$out</span><span style="color:#CE9178;"> -match &quot;未安装&quot;) {</span></span>
<span class="line"><span style="color:#DCDCAA;">    Write-Ok</span><span style="color:#CE9178;"> &quot;Service not installed (already gone): </span><span style="color:#9CDCFE;">$ServiceName</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#C586C0;">    return</span></span>
<span class="line"><span style="color:#CE9178;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DCDCAA;">  Write-Warn</span><span style="color:#CE9178;"> &quot;Service still exists: </span><span style="color:#9CDCFE;">$ServiceName</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#DCDCAA;">  Write-Plan</span><span style="color:#CE9178;"> &quot;Try stop service: </span><span style="color:#9CDCFE;">$ServiceName</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#C586C0;">  if</span><span style="color:#CE9178;"> (</span><span style="color:#9CDCFE;">$Force</span><span style="color:#CE9178;">) { &amp; </span><span style="color:#DCDCAA;">sc.exe</span><span style="color:#CE9178;"> stop </span><span style="color:#9CDCFE;">$ServiceName</span><span style="color:#D4D4D4;"> |</span><span style="color:#DCDCAA;"> Out-Null</span><span style="color:#CE9178;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DCDCAA;">  Write-Plan</span><span style="color:#CE9178;"> &quot;Delete service: </span><span style="color:#9CDCFE;">$ServiceName</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#C586C0;">  if</span><span style="color:#CE9178;"> (</span><span style="color:#9CDCFE;">$Force</span><span style="color:#CE9178;">) { &amp; </span><span style="color:#DCDCAA;">sc.exe</span><span style="color:#CE9178;"> delete </span><span style="color:#9CDCFE;">$ServiceName</span><span style="color:#D4D4D4;"> |</span><span style="color:#DCDCAA;"> Out-Null</span><span style="color:#CE9178;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DCDCAA;">  Write-Ok</span><span style="color:#CE9178;"> &quot;Requested deletion: </span><span style="color:#9CDCFE;">$ServiceName</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#CE9178;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">function</span><span style="color:#DCDCAA;"> Find-And-Remove-OrphanAppIdLocalService</span><span style="color:#CE9178;">([string]</span><span style="color:#9CDCFE;">$LocalServiceName</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#6A9955;">  # Search HKLM &amp; HKCU (real stores). HKCR is merged view.</span></span>
<span class="line"><span style="color:#9CDCFE;">  $roots</span><span style="color:#CE9178;"> = @(</span></span>
<span class="line"><span style="color:#DCDCAA;">    @</span><span style="color:#CE9178;">{ Ps=&quot;Registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\AppID&quot;; </span><span style="color:#9CDCFE;">Export</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&quot;HKLM\\SOFTWARE\\Classes\\AppID&quot;; </span><span style="color:#9CDCFE;">Name</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&quot;HKLM_AppID&quot; },</span></span>
<span class="line"><span style="color:#DCDCAA;">    @</span><span style="color:#CE9178;">{ Ps=&quot;Registry::HKEY_CURRENT_USER\\SOFTWARE\\Classes\\AppID&quot;;  </span><span style="color:#9CDCFE;">Export</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&quot;HKCU\\SOFTWARE\\Classes\\AppID&quot;; </span><span style="color:#9CDCFE;">Name</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&quot;HKCU_AppID&quot; }</span></span>
<span class="line"><span style="color:#CE9178;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9178;">  foreach (</span><span style="color:#9CDCFE;">$r</span><span style="color:#CE9178;"> in </span><span style="color:#9CDCFE;">$roots</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#9CDCFE;">    $rootPs</span><span style="color:#CE9178;"> = </span><span style="color:#9CDCFE;">$r</span><span style="color:#CE9178;">.Ps</span></span>
<span class="line"><span style="color:#C586C0;">    if</span><span style="color:#CE9178;"> (</span><span style="color:#DCDCAA;">-not</span><span style="color:#CE9178;"> (Test-Path </span><span style="color:#569CD6;">-LiteralPath</span><span style="color:#9CDCFE;"> $rootPs</span><span style="color:#CE9178;">)) { </span><span style="color:#C586C0;">continue</span><span style="color:#CE9178;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DCDCAA;">    Write-Plan</span><span style="color:#CE9178;"> &quot;Scan AppID for LocalService=&#39;</span><span style="color:#9CDCFE;">$LocalServiceName</span><span style="color:#CE9178;">&#39; under </span><span style="color:#9CDCFE;">$rootPs</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#9CDCFE;">    $hits</span><span style="color:#CE9178;"> = Get-ChildItem </span><span style="color:#569CD6;">-LiteralPath</span><span style="color:#9CDCFE;"> $rootPs</span><span style="color:#569CD6;"> -ErrorAction</span><span style="color:#CE9178;"> SilentlyContinue </span><span style="color:#D4D4D4;">|</span><span style="color:#DCDCAA;"> ForEach-Object</span><span style="color:#CE9178;"> {</span></span>
<span class="line"><span style="color:#9CDCFE;">      $k</span><span style="color:#CE9178;"> = </span><span style="color:#569CD6;">$_</span><span style="color:#CE9178;">.PSPath</span></span>
<span class="line"><span style="color:#DCDCAA;">      try</span><span style="color:#CE9178;"> {</span></span>
<span class="line"><span style="color:#9CDCFE;">        $p</span><span style="color:#CE9178;"> = Get-ItemProperty </span><span style="color:#569CD6;">-LiteralPath</span><span style="color:#9CDCFE;"> $k</span><span style="color:#569CD6;"> -ErrorAction</span><span style="color:#CE9178;"> Stop</span></span>
<span class="line"><span style="color:#C586C0;">        if</span><span style="color:#CE9178;"> (</span><span style="color:#9CDCFE;">$p</span><span style="color:#CE9178;">.PSObject.Properties.Name -contains &quot;LocalService&quot; -and </span><span style="color:#9CDCFE;">$p</span><span style="color:#CE9178;">.LocalService -eq </span><span style="color:#9CDCFE;">$LocalServiceName</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#CE9178;">          [PSCustomObject]</span><span style="color:#DCDCAA;">@</span><span style="color:#CE9178;">{ PsPath=</span><span style="color:#9CDCFE;">$k</span><span style="color:#CE9178;">; </span><span style="color:#9CDCFE;">Guid</span><span style="color:#D4D4D4;">=</span><span style="color:#569CD6;">$_</span><span style="color:#CE9178;">.PSChildName; </span><span style="color:#9CDCFE;">Root</span><span style="color:#D4D4D4;">=</span><span style="color:#9CDCFE;">$r</span><span style="color:#CE9178;"> }</span></span>
<span class="line"><span style="color:#CE9178;">        }</span></span>
<span class="line"><span style="color:#CE9178;">      } catch { }</span></span>
<span class="line"><span style="color:#CE9178;">    } </span><span style="color:#D4D4D4;">|</span><span style="color:#DCDCAA;"> Where-Object</span><span style="color:#CE9178;"> { </span><span style="color:#569CD6;">$_</span><span style="color:#CE9178;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9178;">    foreach (</span><span style="color:#9CDCFE;">$h</span><span style="color:#CE9178;"> in </span><span style="color:#9CDCFE;">$hits</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#9CDCFE;">      $guid</span><span style="color:#CE9178;"> = </span><span style="color:#9CDCFE;">$h</span><span style="color:#CE9178;">.Guid</span></span>
<span class="line"><span style="color:#9CDCFE;">      $ps</span><span style="color:#CE9178;">   = </span><span style="color:#9CDCFE;">$h</span><span style="color:#CE9178;">.PsPath</span></span>
<span class="line"><span style="color:#9CDCFE;">      $exportKey</span><span style="color:#CE9178;"> = &quot;$(</span><span style="color:#9CDCFE;">$h</span><span style="color:#CE9178;">.Root.Export)</span><span style="color:#D7BA7D;">\\$</span><span style="color:#CE9178;">guid&quot;</span></span>
<span class="line"><span style="color:#9CDCFE;">      $hint</span><span style="color:#CE9178;"> = &quot;AppID_</span><span style="color:#9CDCFE;">$guid</span><span style="color:#CE9178;">\`</span><span style="color:#DCDCAA;">_$LocalServiceName&quot;</span></span>
<span class="line"><span style="color:#DCDCAA;">      Write-Warn &quot;Found</span><span style="color:#CE9178;"> AppID LocalService mapping: </span><span style="color:#9CDCFE;">$ps</span><span style="color:#CE9178;"> (LocalService=$LocalServiceName)&quot;</span></span>
<span class="line"><span style="color:#CE9178;">      Remove-RegKey -PsPath </span><span style="color:#9CDCFE;">$ps</span><span style="color:#CE9178;"> -RegExportPath </span><span style="color:#9CDCFE;">$exportKey</span><span style="color:#CE9178;"> -NameHint </span><span style="color:#9CDCFE;">$hint</span></span>
<span class="line"><span style="color:#CE9178;">    }</span></span>
<span class="line"><span style="color:#CE9178;">  }</span></span>
<span class="line"><span style="color:#CE9178;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9178;">function Find-And-Remove-TypeLibByName([string]</span><span style="color:#9CDCFE;">$TypeLibDisplayName</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#9CDCFE;">  $roots</span><span style="color:#CE9178;"> = @(</span></span>
<span class="line"><span style="color:#CE9178;">    @{ Ps=&quot;Registry::HKEY_LOCAL_MACHINE</span><span style="color:#D7BA7D;">\\S</span><span style="color:#CE9178;">OFTWARE</span><span style="color:#D7BA7D;">\\C</span><span style="color:#CE9178;">lasses</span><span style="color:#D7BA7D;">\\T</span><span style="color:#CE9178;">ypeLib&quot;; Export=&quot;HKLM</span><span style="color:#D7BA7D;">\\S</span><span style="color:#CE9178;">OFTWARE</span><span style="color:#D7BA7D;">\\C</span><span style="color:#CE9178;">lasses</span><span style="color:#D7BA7D;">\\T</span><span style="color:#CE9178;">ypeLib&quot;; Name=&quot;HKLM_TypeLib&quot; },</span></span>
<span class="line"><span style="color:#CE9178;">    @{ Ps=&quot;Registry::HKEY_CURRENT_USER</span><span style="color:#D7BA7D;">\\S</span><span style="color:#CE9178;">OFTWARE</span><span style="color:#D7BA7D;">\\C</span><span style="color:#CE9178;">lasses</span><span style="color:#D7BA7D;">\\T</span><span style="color:#CE9178;">ypeLib&quot;;  Export=&quot;HKCU</span><span style="color:#D7BA7D;">\\S</span><span style="color:#CE9178;">OFTWARE</span><span style="color:#D7BA7D;">\\C</span><span style="color:#CE9178;">lasses</span><span style="color:#D7BA7D;">\\T</span><span style="color:#CE9178;">ypeLib&quot;; Name=&quot;HKCU_TypeLib&quot; }</span></span>
<span class="line"><span style="color:#CE9178;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9178;">  foreach (</span><span style="color:#9CDCFE;">$r</span><span style="color:#CE9178;"> in </span><span style="color:#9CDCFE;">$roots</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#9CDCFE;">    $rootPs</span><span style="color:#CE9178;"> = </span><span style="color:#9CDCFE;">$r</span><span style="color:#CE9178;">.Ps</span></span>
<span class="line"><span style="color:#CE9178;">    if (-not (Test-Path -LiteralPath </span><span style="color:#9CDCFE;">$rootPs</span><span style="color:#CE9178;">)) { continue }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9178;">    Write-Plan &quot;Scan TypeLib </span><span style="color:#C586C0;">for</span><span style="color:#CE9178;"> name contains &#39;$TypeLibDisplayName&#39; under </span><span style="color:#9CDCFE;">$rootPs</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#9CDCFE;">    $guidKeys</span><span style="color:#CE9178;"> = Get-ChildItem -LiteralPath </span><span style="color:#9CDCFE;">$rootPs</span><span style="color:#CE9178;"> -ErrorAction SilentlyContinue</span></span>
<span class="line"><span style="color:#CE9178;">    foreach (</span><span style="color:#9CDCFE;">$g</span><span style="color:#CE9178;"> in </span><span style="color:#9CDCFE;">$guidKeys</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#CE9178;">      # We look under each GUID for versions and check default value(s)</span></span>
<span class="line"><span style="color:#9CDCFE;">      $gpath</span><span style="color:#CE9178;"> = </span><span style="color:#9CDCFE;">$g</span><span style="color:#CE9178;">.PSPath</span></span>
<span class="line"><span style="color:#9CDCFE;">      $matched</span><span style="color:#CE9178;"> = </span><span style="color:#9CDCFE;">$false</span></span>
<span class="line"><span style="color:#CE9178;">      try {</span></span>
<span class="line"><span style="color:#9CDCFE;">        $verKeys</span><span style="color:#CE9178;"> = Get-ChildItem -LiteralPath </span><span style="color:#9CDCFE;">$gpath</span><span style="color:#CE9178;"> -ErrorAction SilentlyContinue</span></span>
<span class="line"><span style="color:#CE9178;">        foreach (</span><span style="color:#9CDCFE;">$v</span><span style="color:#CE9178;"> in </span><span style="color:#9CDCFE;">$verKeys</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#CE9178;">          try {</span></span>
<span class="line"><span style="color:#9CDCFE;">            $p</span><span style="color:#CE9178;"> = Get-ItemProperty -LiteralPath </span><span style="color:#9CDCFE;">$v</span><span style="color:#CE9178;">.PSPath -ErrorAction Stop</span></span>
<span class="line"><span style="color:#CE9178;">            # default value in PowerShell registry provider is &quot;(</span><span style="color:#DCDCAA;">default</span><span style="color:#CE9178;">)&quot; as &quot;(</span><span style="color:#DCDCAA;">default</span><span style="color:#CE9178;">)&quot;? Actually it&#39;s stored as property &quot;(</span><span style="color:#DCDCAA;">default</span><span style="color:#CE9178;">)&quot; not directly.</span></span>
<span class="line"><span style="color:#CE9178;">            # We&#39;ll use Get-Item and read .GetValue(&quot;&quot;) for default.</span></span>
<span class="line"><span style="color:#9CDCFE;">            $rk</span><span style="color:#CE9178;"> = Get-Item -LiteralPath </span><span style="color:#9CDCFE;">$v</span><span style="color:#CE9178;">.PSPath -ErrorAction Stop</span></span>
<span class="line"><span style="color:#9CDCFE;">            $def</span><span style="color:#CE9178;"> = </span><span style="color:#9CDCFE;">$rk</span><span style="color:#CE9178;">.GetValue(&quot;&quot;)</span></span>
<span class="line"><span style="color:#CE9178;">            if (</span><span style="color:#9CDCFE;">$def</span><span style="color:#CE9178;"> -and (</span><span style="color:#9CDCFE;">$def</span><span style="color:#CE9178;"> -like &quot;</span><span style="color:#D4D4D4;">*</span><span style="color:#9CDCFE;">$TypeLibDisplayName</span><span style="color:#D4D4D4;">*</span><span style="color:#CE9178;">&quot;)) { </span><span style="color:#9CDCFE;">$matched</span><span style="color:#CE9178;"> = </span><span style="color:#9CDCFE;">$true</span><span style="color:#CE9178;">; break }</span></span>
<span class="line"><span style="color:#CE9178;">          } catch { }</span></span>
<span class="line"><span style="color:#CE9178;">        }</span></span>
<span class="line"><span style="color:#CE9178;">      } catch { }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9178;">      if (</span><span style="color:#9CDCFE;">$matched</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#9CDCFE;">        $guid</span><span style="color:#CE9178;"> = </span><span style="color:#9CDCFE;">$g</span><span style="color:#CE9178;">.PSChildName</span></span>
<span class="line"><span style="color:#CE9178;">        Write-Warn &quot;Found TypeLib GUID likely Sangfor-related: </span><span style="color:#9CDCFE;">$guid</span><span style="color:#CE9178;"> (</span><span style="color:#DCDCAA;">matched</span><span style="color:#CE9178;"> &#39;$TypeLibDisplayName&#39;)&quot;</span></span>
<span class="line"><span style="color:#9CDCFE;">        $exportKey</span><span style="color:#CE9178;"> = &quot;$(</span><span style="color:#9CDCFE;">$r</span><span style="color:#CE9178;">.Export)</span><span style="color:#D7BA7D;">\\$</span><span style="color:#CE9178;">guid&quot;</span></span>
<span class="line"><span style="color:#9CDCFE;">        $hint</span><span style="color:#CE9178;"> = &quot;TypeLib_</span><span style="color:#9CDCFE;">$guid</span><span style="color:#CE9178;">&quot;</span></span>
<span class="line"><span style="color:#CE9178;">        Remove-RegKey -PsPath </span><span style="color:#9CDCFE;">$gpath</span><span style="color:#CE9178;"> -RegExportPath </span><span style="color:#9CDCFE;">$exportKey</span><span style="color:#CE9178;"> -NameHint </span><span style="color:#9CDCFE;">$hint</span></span>
<span class="line"><span style="color:#CE9178;">      }</span></span>
<span class="line"><span style="color:#CE9178;">    }</span></span>
<span class="line"><span style="color:#CE9178;">  }</span></span>
<span class="line"><span style="color:#CE9178;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9178;">function Find-StringsInCOMRoots([string[]]</span><span style="color:#9CDCFE;">$Needles</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#CE9178;">  # Optional report-only: search some common COM roots for Sangfor strings</span></span>
<span class="line"><span style="color:#9CDCFE;">  $targets</span><span style="color:#CE9178;"> = @(</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;Registry::HKEY_LOCAL_MACHINE</span><span style="color:#D7BA7D;">\\S</span><span style="color:#CE9178;">OFTWARE</span><span style="color:#D7BA7D;">\\C</span><span style="color:#CE9178;">lasses</span><span style="color:#D7BA7D;">\\C</span><span style="color:#CE9178;">LSID&quot;,</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;Registry::HKEY_LOCAL_MACHINE</span><span style="color:#D7BA7D;">\\S</span><span style="color:#CE9178;">OFTWARE</span><span style="color:#D7BA7D;">\\C</span><span style="color:#CE9178;">lasses</span><span style="color:#D7BA7D;">\\A</span><span style="color:#CE9178;">ppID&quot;,</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;Registry::HKEY_LOCAL_MACHINE</span><span style="color:#D7BA7D;">\\S</span><span style="color:#CE9178;">OFTWARE</span><span style="color:#D7BA7D;">\\C</span><span style="color:#CE9178;">lasses</span><span style="color:#D7BA7D;">\\T</span><span style="color:#CE9178;">ypeLib&quot;,</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;Registry::HKEY_CURRENT_USER</span><span style="color:#D7BA7D;">\\S</span><span style="color:#CE9178;">OFTWARE</span><span style="color:#D7BA7D;">\\C</span><span style="color:#CE9178;">lasses</span><span style="color:#D7BA7D;">\\C</span><span style="color:#CE9178;">LSID&quot;,</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;Registry::HKEY_CURRENT_USER</span><span style="color:#D7BA7D;">\\S</span><span style="color:#CE9178;">OFTWARE</span><span style="color:#D7BA7D;">\\C</span><span style="color:#CE9178;">lasses</span><span style="color:#D7BA7D;">\\A</span><span style="color:#CE9178;">ppID&quot;,</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;Registry::HKEY_CURRENT_USER</span><span style="color:#D7BA7D;">\\S</span><span style="color:#CE9178;">OFTWARE</span><span style="color:#D7BA7D;">\\C</span><span style="color:#CE9178;">lasses</span><span style="color:#D7BA7D;">\\T</span><span style="color:#CE9178;">ypeLib&quot;</span></span>
<span class="line"><span style="color:#CE9178;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9178;">  Write-Host &quot;&quot;</span></span>
<span class="line"><span style="color:#CE9178;">  Write-Host &quot;===== REPORT: COM-related keys containing needles =====&quot; -ForegroundColor Magenta</span></span>
<span class="line"><span style="color:#CE9178;">  foreach (</span><span style="color:#9CDCFE;">$t</span><span style="color:#CE9178;"> in </span><span style="color:#9CDCFE;">$targets</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#CE9178;">    if (-not (Test-Path -LiteralPath </span><span style="color:#9CDCFE;">$t</span><span style="color:#CE9178;">)) { continue }</span></span>
<span class="line"><span style="color:#CE9178;">    foreach (</span><span style="color:#9CDCFE;">$n</span><span style="color:#CE9178;"> in </span><span style="color:#9CDCFE;">$Needles</span><span style="color:#CE9178;">) {</span></span>
<span class="line"><span style="color:#CE9178;">      Write-Plan &quot;Search under </span><span style="color:#9CDCFE;">$t</span><span style="color:#CE9178;"> for &#39;$n&#39; (</span><span style="color:#DCDCAA;">report</span><span style="color:#CE9178;"> only)&quot;</span></span>
<span class="line"><span style="color:#CE9178;">      # avoid huge recursion blowing up: limit to 2-level scan quickly</span></span>
<span class="line"><span style="color:#CE9178;">      try {</span></span>
<span class="line"><span style="color:#CE9178;">        Get-ChildItem -LiteralPath </span><span style="color:#9CDCFE;">$t</span><span style="color:#CE9178;"> -ErrorAction SilentlyContinue | ForEach-Object {</span></span>
<span class="line"><span style="color:#9CDCFE;">          $k1</span><span style="color:#CE9178;"> = </span><span style="color:#569CD6;">$_</span><span style="color:#CE9178;">.PSPath</span></span>
<span class="line"><span style="color:#CE9178;">          # check values on this key</span></span>
<span class="line"><span style="color:#CE9178;">          try {</span></span>
<span class="line"><span style="color:#9CDCFE;">            $item</span><span style="color:#CE9178;"> = Get-Item -LiteralPath </span><span style="color:#9CDCFE;">$k1</span><span style="color:#CE9178;"> -ErrorAction Stop</span></span>
<span class="line"><span style="color:#CE9178;">            foreach (</span><span style="color:#9CDCFE;">$vn</span><span style="color:#CE9178;"> in </span><span style="color:#9CDCFE;">$item</span><span style="color:#CE9178;">.GetValueNames()) {</span></span>
<span class="line"><span style="color:#9CDCFE;">              $vv</span><span style="color:#CE9178;"> = </span><span style="color:#9CDCFE;">$item</span><span style="color:#CE9178;">.GetValue(</span><span style="color:#9CDCFE;">$vn</span><span style="color:#CE9178;">)</span></span>
<span class="line"><span style="color:#CE9178;">              if (</span><span style="color:#9CDCFE;">$vv</span><span style="color:#CE9178;"> -is [string] -and </span><span style="color:#9CDCFE;">$vv</span><span style="color:#CE9178;"> -match [regex]::Escape(</span><span style="color:#9CDCFE;">$n</span><span style="color:#CE9178;">)) {</span></span>
<span class="line"><span style="color:#CE9178;">                Write-Host &quot;[HIT] </span><span style="color:#9CDCFE;">$k1</span><span style="color:#CE9178;">  value &#39;$vn&#39; contains &#39;$n&#39;&quot; -ForegroundColor DarkCyan</span></span>
<span class="line"><span style="color:#CE9178;">              }</span></span>
<span class="line"><span style="color:#CE9178;">            }</span></span>
<span class="line"><span style="color:#CE9178;">          } catch {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9178;">          # one more level down</span></span>
<span class="line"><span style="color:#CE9178;">          try {</span></span>
<span class="line"><span style="color:#CE9178;">            Get-ChildItem -LiteralPath </span><span style="color:#9CDCFE;">$k1</span><span style="color:#CE9178;"> -ErrorAction SilentlyContinue | ForEach-Object {</span></span>
<span class="line"><span style="color:#9CDCFE;">              $k2</span><span style="color:#CE9178;"> = </span><span style="color:#569CD6;">$_</span><span style="color:#CE9178;">.PSPath</span></span>
<span class="line"><span style="color:#CE9178;">              try {</span></span>
<span class="line"><span style="color:#9CDCFE;">                $item2</span><span style="color:#CE9178;"> = Get-Item -LiteralPath </span><span style="color:#9CDCFE;">$k2</span><span style="color:#CE9178;"> -ErrorAction Stop</span></span>
<span class="line"><span style="color:#CE9178;">                foreach (</span><span style="color:#9CDCFE;">$vn2</span><span style="color:#CE9178;"> in </span><span style="color:#9CDCFE;">$item2</span><span style="color:#CE9178;">.GetValueNames()) {</span></span>
<span class="line"><span style="color:#9CDCFE;">                  $vv2</span><span style="color:#CE9178;"> = </span><span style="color:#9CDCFE;">$item2</span><span style="color:#CE9178;">.GetValue(</span><span style="color:#9CDCFE;">$vn2</span><span style="color:#CE9178;">)</span></span>
<span class="line"><span style="color:#CE9178;">                  if (</span><span style="color:#9CDCFE;">$vv2</span><span style="color:#CE9178;"> -is [string] -and </span><span style="color:#9CDCFE;">$vv2</span><span style="color:#CE9178;"> -match [regex]::Escape(</span><span style="color:#9CDCFE;">$n</span><span style="color:#CE9178;">)) {</span></span>
<span class="line"><span style="color:#CE9178;">                    Write-Host &quot;[HIT] </span><span style="color:#9CDCFE;">$k2</span><span style="color:#CE9178;">  value &#39;$vn2&#39; contains &#39;$n&#39;&quot; -ForegroundColor DarkCyan</span></span>
<span class="line"><span style="color:#CE9178;">                  }</span></span>
<span class="line"><span style="color:#CE9178;">                }</span></span>
<span class="line"><span style="color:#CE9178;">              } catch {}</span></span>
<span class="line"><span style="color:#CE9178;">            }</span></span>
<span class="line"><span style="color:#CE9178;">          } catch {}</span></span>
<span class="line"><span style="color:#CE9178;">        }</span></span>
<span class="line"><span style="color:#CE9178;">      } catch {}</span></span>
<span class="line"><span style="color:#CE9178;">    }</span></span>
<span class="line"><span style="color:#CE9178;">  }</span></span>
<span class="line"><span style="color:#CE9178;">  Write-Host &quot;===== END REPORT =====&quot; -ForegroundColor Magenta</span></span>
<span class="line"><span style="color:#CE9178;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9178;"># ------------------ MAIN ------------------</span></span>
<span class="line"><span style="color:#CE9178;">if (-not (Test-Admin)) {</span></span>
<span class="line"><span style="color:#CE9178;">  throw &quot;Please run PowerShell as Administrator.&quot;</span></span>
<span class="line"><span style="color:#CE9178;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9178;">Write-Host &quot;Sangfor leftover cleanup script&quot; -ForegroundColor White</span></span>
<span class="line"><span style="color:#CE9178;">Write-Host (&quot;Mode: &quot; + ($(if (</span><span style="color:#9CDCFE;">$Force</span><span style="color:#CE9178;">) { </span><span style="color:#DCDCAA;">&quot;FORCE (will delete)&quot;</span><span style="color:#CE9178;"> } else { &quot;DRY-RUN (no deletion)&quot; }))) -ForegroundColor White</span></span>
<span class="line"><span style="color:#DCDCAA;">Write-Host</span><span style="color:#CE9178;"> (&quot;BackupDir: &quot; + </span><span style="color:#9CDCFE;">$BackupDir</span><span style="color:#CE9178;">) -ForegroundColor White</span></span>
<span class="line"><span style="color:#DCDCAA;">Write-Host</span><span style="color:#CE9178;"> &quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># 0) Ensure SangforPWEx service really gone (your case: 1060)</span></span>
<span class="line"><span style="color:#DCDCAA;">Remove-ServiceIfExists</span><span style="color:#569CD6;"> -ServiceName</span><span style="color:#CE9178;"> &quot;SangforPWEx&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># 1) Remove orphan AppID mappings LocalService=SangforPWEx</span></span>
<span class="line"><span style="color:#DCDCAA;">Find-And-Remove-OrphanAppIdLocalService</span><span style="color:#569CD6;"> -LocalServiceName</span><span style="color:#CE9178;"> &quot;SangforPWEx&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># 2) Remove TypeLib entries that display as SangforPWLib (including your GUID)</span></span>
<span class="line"><span style="color:#DCDCAA;">Find-And-Remove-TypeLibByName</span><span style="color:#569CD6;"> -TypeLibDisplayName</span><span style="color:#CE9178;"> &quot;SangforPWLib&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># 3) Optional report for any other Sangfor strings in COM roots (no deletion)</span></span>
<span class="line"><span style="color:#DCDCAA;">Find-StringsInCOMRoots</span><span style="color:#569CD6;"> -Needles</span><span style="color:#CE9178;"> @(</span><span style="color:#DCDCAA;">&quot;Sangfor&quot;,</span><span style="color:#CE9178;"> &quot;PWEx&quot;, &quot;SangforPWLib&quot;, &quot;SangforVnic&quot;)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DCDCAA;">Write-Host</span><span style="color:#CE9178;"> &quot;&quot;</span></span>
<span class="line"><span style="color:#DCDCAA;">Write-Ok</span><span style="color:#CE9178;"> &quot;Finished. If you ran in DRY-RUN, rerun with -Force to apply removals.&quot;</span></span>
<span class="line"><span style="color:#DCDCAA;">Write-Host</span><span style="color:#CE9178;"> &quot;Backups (if any) are stored in: </span><span style="color:#9CDCFE;">$BackupDir</span><span style="color:#CE9178;">&quot; </span><span style="color:#569CD6;">-ForegroundColor</span><span style="color:#CE9178;"> Gray</span></span></code></pre></div><h3 id="本地文件" tabindex="-1"><a class="header-anchor" href="#本地文件"><span>本地文件</span></a></h3><p>全局搜索Sangfor，在sysWoW64下找到了一些dll，通过以下命令搜索文件相关性，发现都是一些不紧要的进程需要用到这些DLL，就直接删除了。</p><div class="language-pwsh" data-highlighter="shiki" data-ext="pwsh" data-title="pwsh" style="background-color:#1E1E1E;color:#D4D4D4;"><pre class="shiki dark-plus vp-code"><code><span class="line"><span>Get-Process | ForEach-Object {</span></span>
<span class="line"><span>  try {</span></span>
<span class="line"><span>    $_.Modules | Where-Object { $_.FileName -match &quot;Sangfor&quot; }</span></span>
<span class="line"><span>  } catch {}</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>剩余还有一些driverstore文件，这些简单来说是当前会话的驱动加载记录，可以不管，如果以一定要删除，可以通过pnputil命令删除，先通过以下命令找到正确的driver名称：</p><div class="language-pwsh" data-highlighter="shiki" data-ext="pwsh" data-title="pwsh" style="background-color:#1E1E1E;color:#D4D4D4;"><pre class="shiki dark-plus vp-code"><code><span class="line"><span>pnputil /enum-drivers | findstr /i sangfor</span></span></code></pre></div><p>得到以下输出:</p><div class="language-pwsh" data-highlighter="shiki" data-ext="pwsh" data-title="pwsh" style="background-color:#1E1E1E;color:#D4D4D4;"><pre class="shiki dark-plus vp-code"><code><span class="line"><span>注册名称(Published Name)： XXX</span></span>
<span class="line"><span>原始名称:      sangforvnic.inf</span></span>
<span class="line"><span>提供程序名称:      Sangfor.inc</span></span>
<span class="line"><span>签名者姓名:        Sangfor Technologies Co.,Ltd</span></span></code></pre></div><p>根据注册名称运行一下命令：</p><div class="language-pwsh" data-highlighter="shiki" data-ext="pwsh" data-title="pwsh" style="background-color:#1E1E1E;color:#D4D4D4;"><pre class="shiki dark-plus vp-code"><code><span class="line"><span>pnputil /delete-driver 注册名称 /uninstall /force</span></span></code></pre></div><p>由于我的系统中上述驱动没有注册了，所以没有注册名称，无法也不需要通过pnputil删除，直接不管。</p>`,34)]))}const C=n(o,[["render",e]]),y=JSON.parse(`{"path":"/win_linux/sangfor-uninstall.html","title":"Win下彻底清理Sangfor深信服相关文件","lang":"zh-CN","frontmatter":{"title":"Win下彻底清理Sangfor深信服相关文件","isOriginal":true,"category":["Windows"],"tag":["sangfor"],"description":"大概一年多前对象需要用我的电脑完成工作相关的一些事情，需要安装深信服的一些软件来远程操控公司电脑。事后我卸载了相关软件，运行的是软件自带的uninstall程序。 但是最近查看任务管理器的进程列表，竟然还是看到了Sangfor开头的进程，甚是无语。 删除服务 想到每次开机都会自启动，第一想法就是系统服务项中会不会有，打开Windows的服务管理(ser...","head":[["meta",{"property":"og:url","content":"https://jayczee.cn/win_linux/sangfor-uninstall.html"}],["meta",{"property":"og:site_name","content":"Jayczee's Blog"}],["meta",{"property":"og:title","content":"Win下彻底清理Sangfor深信服相关文件"}],["meta",{"property":"og:description","content":"大概一年多前对象需要用我的电脑完成工作相关的一些事情，需要安装深信服的一些软件来远程操控公司电脑。事后我卸载了相关软件，运行的是软件自带的uninstall程序。 但是最近查看任务管理器的进程列表，竟然还是看到了Sangfor开头的进程，甚是无语。 删除服务 想到每次开机都会自启动，第一想法就是系统服务项中会不会有，打开Windows的服务管理(ser..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2026-01-27T03:39:05.000Z"}],["meta",{"property":"article:tag","content":"sangfor"}],["meta",{"property":"article:modified_time","content":"2026-01-27T03:39:05.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Win下彻底清理Sangfor深信服相关文件\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2026-01-27T03:39:05.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Jayczee\\",\\"url\\":\\"https://jayczee.cn\\"}]}"]]},"headers":[{"level":2,"title":"删除服务","slug":"删除服务","link":"#删除服务","children":[{"level":3,"title":"管理员运行services.msc","slug":"管理员运行services-msc","link":"#管理员运行services-msc","children":[]},{"level":3,"title":"改注册表","slug":"改注册表","link":"#改注册表","children":[]},{"level":3,"title":"sc delete命令","slug":"sc-delete命令","link":"#sc-delete命令","children":[]}]},{"level":2,"title":"删除驱动","slug":"删除驱动","link":"#删除驱动","children":[{"level":3,"title":"sc delete命令","slug":"sc-delete命令-1","link":"#sc-delete命令-1","children":[]}]},{"level":2,"title":"其他残留","slug":"其他残留","link":"#其他残留","children":[{"level":3,"title":"注册表","slug":"注册表","link":"#注册表","children":[]},{"level":3,"title":"本地文件","slug":"本地文件","link":"#本地文件","children":[]}]}],"git":{"createdTime":1769485145000,"updatedTime":1769485145000,"contributors":[{"name":"Jayczee","username":"Jayczee","email":"jayczee@yeah.net","commits":1,"url":"https://github.com/Jayczee"}]},"readingTime":{"minutes":6.02,"words":1807},"filePathRelative":"win_linux/sangfor-uninstall.md","localizedDate":"2026年1月27日","excerpt":"<p>大概一年多前对象需要用我的电脑完成工作相关的一些事情，需要安装深信服的一些软件来远程操控公司电脑。事后我卸载了相关软件，运行的是软件自带的uninstall程序。</p>\\n<p>但是最近查看任务管理器的进程列表，竟然还是看到了Sangfor开头的进程，甚是无语。</p>\\n<h2>删除服务</h2>\\n<p>想到每次开机都会自启动，第一想法就是系统服务项中会不会有，打开Windows的服务管理(services.msc)，按名称排列寻找S开头的服务，好家伙，第一个就是<code>Sangfor VPN Security Protect Service</code>，关闭此服务后我尝试设置禁用，竟然还拒绝访问！随即尝试以下步骤：</p>","autoDesc":true}`);export{C as comp,y as data};
